---
layout: post
title: "è®©CIé‡Œçš„Swift Package Manager HTTPé‰´æƒä¹Ÿèƒ½666çš„é¿å‘æŒ‡å—"
excerpt: "Make swift package manager working well in continuous integration workflows"
tags: [CI, Swift Package Manager, Git]
author: Jason Jiang
---

# å‰è¿°
æœ¬æ–‡æ˜¯ä¸€æ¬¡æ¢ã€Moã€‘ç´¢ã€Yuã€‘è¿‡ç¨‹çš„è®°è¿°ï¼Œä¸ºäº†èŠ‚çº¦æ‚¨çš„å®è´µæ—¶é—´ï¼Œéœ€è¦æ‰§è¡Œæ­¥éª¤çš„ï¼Œè¯·ç›´æ¥æŸ¥é˜…æ­¥éª¤æ€»ç»“ã€‚

# é‡åˆ°é—®é¢˜   
ä¼—æ‰€å‘¨çŸ¥ï¼ŒSwift Package Manageræ˜¯Appleå®˜æ–¹å‡ºå“çš„ä¸€å¥—åŒ…ç®¡ç†å·¥å…·ï¼Œå†…ç½®äºXcodeï¼Œå…¶å…·æœ‰è¾ƒå¥½çš„ç¦»æ•£å‹ï¼Œç¼–è¯‘æ—¶å†æ‹‰å–ä¾èµ–çš„ç‰¹æ€§ä½¿å¾—å®¿ä¸»å·¥ç¨‹æ›´è½»ä¾¿ï¼Œç›¸è¾ƒä¼ ç»Ÿcocoapodæœ‰äº²çˆ¹æ”¯æŒï¼Œåˆè½»é‡çš„ä¼˜ç‚¹ã€‚æˆ‘å¸åœ¨æ•´ä½“åˆ‡æ¢åˆ°xcframeworkåä¹Ÿå¼€å§‹è½¬æŠ•Swift Package Managerçš„æ€€æŠ±ã€‚

ç„¶è€Œä½¿ç”¨è¿‡ç¨‹ä¸­æˆ‘ä»¬å‘ç°CIåœ¨æ‹‰å–ä¾èµ–æ—¶ä¼šå‘ç”Ÿé‰´æƒé—®é¢˜ï¼Œè¿™åœ¨Xcodeå¥å…¨çš„GUIç•Œé¢ä¸‹ï¼Œæœ¬ä¸åº”è¯¥æ˜¯ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼Œç„¶è€Œï¼Œåœ¨æ ¹æ®[Appleå®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/swift_packages/building_swift_packages_or_apps_that_use_them_in_continuous_integration_workflows "Appleå®˜æ–¹æ–‡æ¡£")ä¸­çš„æè¿°æˆ‘ä»¬å‘ç°ï¼ŒSPMçš„CIé‰´æƒæ–¹å¼ï¼ŒAppleåªæä¾›äº†SSHå’ŒXcode Serverä¸¤æ¡è·¯å­ï¼Œï¼ˆXcode Serverç”¨çš„äººå¤ªå°‘ï¼Œä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ä½¿ç”¨Jenkinsè¿›è¡Œè‡ªåŠ¨åŒ–æ„å»ºï¼Œæ­¤æ—¶åˆä½¿ç”¨äº†éœ€è¦é‰´æƒçš„SPMï¼Œè‹¥ä¸å·§åˆç¢°ä¸Šå› ç‰¹æ®ŠåŸå› SSHä¸èƒ½è¢«CIæœºå™¨è®¿é—®ï¼Œé‚£ä¹ˆä½ å°±è·Ÿæˆ‘ä¸€æ ·é‡åˆ°äº†ä¸€ä¸ªå°´å°¬çš„æ— æ³•è®©Jenkinsé€šè¿‡é‰´æƒæ‹‰å–SPMä¾èµ–çš„é—®é¢˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

![Alt text](/img/SwiftPM/auth_failed.png "Optional title")

# ä½œå‡ºå‡è®¾   
åœ¨é‡åˆ°è¯¥é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆè€ƒè™‘çš„æ˜¯äº‹å…ˆå°†å¯†ç æ‰”ç»™Gitï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“ç†è®ºä¸Šï¼Œéœ€è¦é‰´æƒçš„Gitä»“åº“ï¼Œåœ¨æˆ‘ä»¬çš„æ¯ä¸€æ¬¡æ“ä½œæ—¶éƒ½éœ€è¦è¿›è¡Œç”¨æˆ·åå’Œå¯†ç çš„é‰´æƒï¼Œæ˜¯Gitå·¥å…·ç¼“å­˜äº†æˆ‘ä»¬çš„é‰´æƒå‡­è¯ï¼Œä½¿å¾—åœ¨æˆ‘ä»¬çš„æ—¥å¸¸ä½¿ç”¨ä¸­ï¼Œåªéœ€è¦åœ¨é¦–æ¬¡clone Gitä»“åº“çš„æ—¶å€™éœ€è¦è¿›è¡Œé‰´æƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæå‰å°†éœ€è¦é‰´æƒçš„Gitä»“åº“çš„å‡­æ®è®¾ç½®åˆ°Gitå·¥å…·ï¼Œè®©Gitåœ¨æ¯æ¬¡æ‹‰å–çš„æ—¶å€™è‡ªåŠ¨æŠŠé‰´æƒçš„ç”¨æˆ·åå’Œå¯†ç å¡«ä¸Šï¼Œå°±èƒ½è§£å†³HTTPé“¾æ¥ä¸‹Gitä»“åº“çš„é‰´æƒé—®é¢˜ï¼Œè¿™TMä¸å°±æ˜¯åŠå°æ—¶çš„äº‹æƒ…ï¼ŒNiceğŸ˜ã€äº‹å®ä¸Š è¿™æ˜¯ä¸ªFlagã€‘

# ç–¯ç‹‚è¸©å‘

1. è¿œç¨‹è¿æ¥æ²¡æœ‰å‘½ä»¤å›æ˜¾

ä½¿ç”¨SSHè¿œç¨‹è¿æ¥CIæœºå™¨æ—¶ï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œ```git credential-osxkeychain```ç›¸å…³æŒ‡ä»¤æ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œä½†å®é™…ä¸Šå®ƒå·²ç»æ‰§è¡ŒæˆåŠŸäº†ï¼Œæ‰€ä»¥åƒä¸‡ä¸è¦åœ¨è¿™ç§çŠ¶æ€ä¸‹æ‰§è¡Œ```git credential-osxkeychain get```æ¥æŸ¥çœ‹ä¿å­˜çš„å‡­è¯ï¼Œå¦åˆ™ä½ ä¼šæ€€ç–‘äººç”Ÿã€‚

æ­£ç¡®çš„åšæ³•æ˜¯ä½¿ç”¨GUIå·¥å…·å¦‚VNCæˆ–è€…Macè‡ªå¸¦çš„å±å¹•å…±äº«å·¥å…·è¿æ¥CIæœºå™¨ï¼Œå†åˆ°æœºå™¨ä¸Šæ‰“å¼€ç»ˆç«¯æ‰§è¡ŒæŒ‡ä»¤ã€‚è¿™æ ·å°±èƒ½çœ‹åˆ°æ­£ç¡®çš„å›æ˜¾ä»¥ä½¿å¾—å·¥ä½œå¾—ä»¥æ­£å¸¸è¿›è¡Œã€‚

2. è®¾ç½®äº†å‡­æ®ä¹ŸéªŒè¯è®¾ç½®æˆåŠŸäº†ï¼ŒGitå‘½ä»¤è¡Œä¾ç„¶éœ€è¦è¾“å…¥å‡­æ®

è®¾ç½®çš„å‡­æ®éœ€è¦ä¿è¯hostè·¯å¾„ã€protocolåè®®ä¸Gitä»“åº“é«˜åº¦ä¸€è‡´ï¼Œæ‰“é”™äº†å³ä½¿èƒ½ä¿å­˜è¿›å»ä¹Ÿæ˜¯ç”¨ä¸äº†çš„ã€‚

ç‰¹åˆ«çš„ï¼Œå¦‚æœGitä»“åº“è·¯å¾„ä¸Šå¸¦ç«¯å£ï¼Œé‚£ä¹ˆhostéœ€è¦å†™å…¨åŸŸåå’Œç«¯å£å·ï¼Œå¦‚

 ``` host=xxx.xxx.xxx:1234 ``` 

3. é’¥åŒ™ä¸²è®¿é—®è®¾ç½®è´¦å·å¯†ç æ— æ•ˆ

ç›´æ¥åœ¨é’¥åŒ™ä¸²è®¿é—®ä¸ŠGitå·¥å…·ä¹Ÿæ˜¯æ— æ³•ç”¨æ¥é‰´æƒçš„ï¼Œè¿˜æ˜¯éœ€è¦é€šè¿‡æ‰§è¡Œ```git credential-osxkeychain store```æ¥ä¿å­˜

4. æŠŠSPMæ”¾åˆ°å·¥ç¨‹ä»“åº“æœ¬åœ°ä¼å›¾æ›´æ”¹SPM cacheè·¯å¾„

åœ¨Fastlaneä¸­å¯ä»¥ä½¿ç”¨```cloned_source_packages_path```å‚æ•°å°†ä¾èµ–æ”¾åˆ°å·¥ç¨‹ä¸­ï¼Œç„¶åå†è‡ªå®šä¹‰SPMä»¥æ¥åŒ…è·¯å¾„ï¼Œç†è®ºä¸Šå¯ä»¥å®ç°ä½¿ç”¨å·¥ç¨‹æ–‡ä»¶å¤¹ä¸‹çš„SPMä¾èµ–åŒ…æ¥è¿›è¡Œç¼–è¯‘ï¼Œä½†å®é™…ä¸Šç»è¿‡å¤šæ¬¡åå°è¯•å‘ç°ï¼Œå®ƒä¼šæŠ¥å‡ºä¸€ä¸ªinvalidé”™è¯¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

![Alt text](/img/SwiftPM/cache_invalid.png "Optional title")

å¹¶ä¸”è¿™æ ·çš„æ“ä½œæŠŠä¾èµ–æ‹‰åˆ°äº†å·¥ç¨‹ç›®å½•ä¸‹ï¼Œè¿èƒŒäº†æˆ‘ä»¬ä½¿ç”¨SPMå‡å°‘cocoapodså¯¹é¡¹ç›®å·¥ç¨‹çš„ä¾µå…¥è¿™ä¸€åˆè¡·ï¼Œæ‰€ä»¥ä¸å»ºè®®å¤§å®¶å°è¯•ï¼Œå¦‚æœè¯»è€…çŸ¥é“ä¸ºä½•è¿™ä¸ªè‡ªå®šä¹‰çš„æœ¬åœ°SPMè·¯å¾„ä¸èƒ½æ­£å¸¸ç¼–è¯‘æ¬¢è¿è¯„è®ºæˆ–ç»™æˆ‘ç•™è¨€ã€‚

5. å¯†ç å·²æˆåŠŸé…ç½®ï¼Œä½†Xcodeè‡ªå¸¦çš„SPMè·å–ä¸åˆ°é‰´æƒä¿¡æ¯

ç»è¿‡æ­£ç¡®çš„è®¾ç½®åï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ç›´æ¥ç”¨```git clone```æŒ‡ä»¤æ‹‰å–SPMä¾èµ–ï¼Œè€Œä¸éœ€è¦è¾“å…¥é‰´æƒä¿¡æ¯äº†ã€‚ä½†åœ¨xcodeä¸­ä½¿ç”¨å…¶è‡ªå¸¦çš„åŒ…ç®¡ç†å·¥å…·æ·»åŠ SPMä¾èµ–æ—¶ï¼Œè¿˜æ˜¯ä¼šæç¤ºè¾“å…¥é‰´æƒä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºç”¨xcodeæ‰“å¼€å·¥ç¨‹æ—¶ï¼Œå®ƒé»˜è®¤ä½¿ç”¨äº†Xcodeè‡ªå¸¦çš„Gitæ¥è¿›è¡Œæ“ä½œï¼Œè¯»å–çš„æ˜¯å®ƒè‡ªå·±ç»´æŠ¤çš„é‰´æƒä¿¡æ¯ï¼Œè€Œæˆ‘ä»¬ä¿å­˜çš„å‡­æ®æ˜¯ä¿å­˜åœ¨äº†ç³»ç»Ÿçš„Gitå·¥å…·ä¸Šï¼ŒXcode GUIæ— æ³•è¯»å–åˆ°ï¼Œå› ä¸ºå®ƒæ˜¯ä¸¤ä¸ªä¸åŒçš„Gitï¼Œä½¿ç”¨ä¸¤å¥—ä¸åŒçš„é‰´æƒä¿¡æ¯ã€‚

# æˆæ•ˆåˆæ˜¾

ä»å‰é¢çš„äº”ä¸ªå¤§å‘é‡Œçˆ¬å‡ºæ¥åï¼Œç»ˆäºåœ¨å‘½ä»¤è¡Œä¸‹ä½¿ç”¨```git clone```æŒ‡ä»¤å¯ä»¥ç›´æ¥æŠŠHttpçš„ä¾èµ–åº“æ‹‰å–åˆ°æœ¬åœ°ï¼Œè€Œä¸éœ€è¦å†è¾“å…¥ç”¨æˆ·åå’Œå¯†ç äº†ã€‚ğŸŒˆğŸŒˆğŸŒˆ

![Alt text](/img/SwiftPM/clone_success.png "Optional title")

# å®Œç¾äº¤å·®

ç»è¿‡ä¸€é¡¿çŒ›å¦‚è™çš„æ“ä½œï¼Œç»ˆäºåœ¨Jenkinsçš„æ§å°ä¸Šå‡ºç°äº†æ‹‰å–SPMä¾èµ–æˆåŠŸçš„LogğŸ«‚

![Alt text](/img/SwiftPM/success.png "Optional title")

# æ­¥éª¤æ€»ç»“

* **æ£€æŸ¥Macå¯ç”¨çš„é‰´æƒååŠ©å·¥å…·**
  
ä½¿ç”¨å‘½ä»¤```git config  -l | grep credential.helper```æŸ¥çœ‹ï¼ŒMacæ˜¯å¦ä½¿ç”¨äº†```osxkeychain```ï¼Œå¦‚æœæ²¡æœ‰è¯·ä½¿ç”¨åº¦å¨˜å°†è¿™é‡Œé…ç½®ä¸º```osxkeychain```

* **è®¾ç½®xcodebuild/Fastlaneä½¿ç”¨CIæœºå™¨çš„Git**

ç”±äºxcodeè‡ªå¸¦Gitï¼Œé»˜è®¤```xcodebuild```å‘½ä»¤ä½¿ç”¨çš„æ˜¯xcodeè‡ªå¸¦çš„Gitï¼Œç„¶è€Œå®ƒå¹¶ä¸ä¼šä»ç³»ç»Ÿçš„```osxkeychain```ä¸­è·å–é‰´æƒä¿¡æ¯ã€‚å› æ­¤è¿™é‡Œéœ€è¦åœ¨```xcodebuild```å‘½ä»¤ååŠ ä¸Š```-scmProvider system```ï¼ŒæŒ‡å®šxcodeä½¿ç”¨CIæœºå™¨çš„Gitè€Œä¸æ˜¯xcodeè‡ªå¸¦çš„ã€‚

å¦‚æœCIä½¿ç”¨Fastlaneï¼Œåˆ™éœ€è¦åœ¨gymé‡ŒåŠ ä¸Š```use_system_scm: true```å¦‚ï¼š

```
gym(
      toolchain: "xxx",
      scheme: "#{SCHEME}",
      export_method: "#{EXPORT_METHOD}",
      configuration: option[:configuration],
      output_directory: "#{OUTPUT_DIRECTORY}",
      include_symbols: true,
      include_bitcode: false,
      xcargs: 'DEBUG_INFORMATION_FORMAT="dwarf-with-dsym"',
      output_name: "#{IPA_NAME}",
      export_xcargs: "-allowProvisioningUpdates",
      use_system_scm: true
    )
```

* **å°†Gitå‡­æ®è®¾ç½®åˆ°CIæœºå™¨**

è¿™é‡Œå¯ä»¥ä½¿ç”¨äº¤äº’å¼å‘½ä»¤```git credential-osxkeychain store```å°†Gitå‡­æ®ä¿å­˜åˆ°CIæœºå™¨ï¼Œå¦‚ï¼š

```
$git credential-osxkeychain store
host=xxx.xxx.xxx:xxx
protocol=http
username=xxxx
password=xxxx

$git credential-osxkeychain get
host=xxx.xxx.xxx:xxx

>password=xxxx
>username=xxxx
```
##### æ³¨æ„ï¼šè¿™é‡Œstoreçš„æ—¶å€™```password=xxxx```åé¢éœ€è¦æŒ‰ä¸¤æ¬¡å›è½¦ï¼Œä»¥ç¡®è®¤å‰é¢çš„è¾“å…¥ã€‚åŒç†ï¼Œgetçš„æ—¶å€™host=xxx.xxx.xxx:xxxåé¢ä¹Ÿæ˜¯éœ€è¦ä¸¤ä¸ªå›è½¦ï¼Œå½“çœ‹åˆ°å‘½ä»¤è¡Œè¾“å‡ºäº†æ­£ç¡®çš„passwordå’Œusernameå³ä¸ºä¿å­˜æˆåŠŸã€‚å¦å¤–ï¼Œå¦‚æœè¿™é‡ŒGitä»“åº“è·¯å¾„æœ‰ç«¯å£å·ï¼Œè¯·åœ¨hostä¸­è¾“å…¥å¸¦ç«¯å£å·ã€å¸¦å…¨åŸŸåçš„urlï¼Œä¸ç„¶ä¼šæ‰å…¥å‰æ–‡æ‰€è¿°çš„å‘ä¸­ï¼Œåˆ‡è®°ï¼

**ç¬¬ä¸€æ¬¡æ“ä½œ``` credential-osxkeychain store ```æ—¶ï¼Œå¯èƒ½ä¼šå¼¹å‡ºGitè¯»å–Keychainçš„è®¸å¯å¯¹è¯æ¡†ï¼Œå»ºè®®é€‰æ‹©æ°¸è¿œå…è®¸ï¼Œå¹¶è¾“å…¥CIæœºå™¨çš„ç®¡ç†å‘˜å¯†ç ï¼Œä¹‹åæ‰§è¡Œæ‰€æœ‰Gitæ“ä½œæ—¶ï¼Œéœ€è¦è¯»å–Keychainä¸­ä¿å­˜çš„å‡­æ®ä¾¿ä¸ä¼šå†å¼¹å‡ºå¯¹è¯æ¡†**


å¦‚æœè¿™é‡Œæƒ³ç”¨CIå‘½ä»¤ä¿å­˜ç”¨æˆ·åå’Œå¯†ç ï¼Œé‚£ä¹ˆå¯ä»¥å°†ä¸‹æ–¹ä¿¡æ¯ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå¦‚```Password```

```
host=xxx.xxx.xxx:xxx
protocol=http
username=xxxx
password=xxxx
```
ç„¶ååœ¨å¯¹åº”è·¯å¾„æ‰§è¡Œ```cat Password | git credential-osxkeychain store```å³å¯


å¦‚æœåœ¨ä½¿ã€Daã€‘ç”¨ã€Gongã€‘è¿‡ç¨‹ä¸­å‘ç°é™¤äº†ä¸Šè¿°å‘ç‚¹ä»¥å¤–çš„å¤§å‘ï¼Œæˆ–ä¾ç…§æœ¬æŒ‡å—æ— æ³•å®ŒæˆCIå’ŒSPMçš„é…ç½®ï¼Œæ¬¢è¿ä¸[æˆ‘](href "mailto:jiangx.jason@gmail.com")å–å¾—è”ç³»ï¼Œæˆ‘å°†ç»™äºˆä¸€å®šçš„å¸®åŠ©ï¼Œå¹¶æŠŠé—æ¼å‘ç‚¹è¡¥å……åˆ°è¿™ç¯‡æŒ‡å—ä¸­ã€‚å†æ¬¡æ„Ÿè°¢å„ä½å¤§ä½¬å¯¹æˆ‘ã€Da Gong Renã€‘çš„æ”¯æŒï¼ŒæœŸæœ›æœ¬æŒ‡å—èƒ½ä¸ºæ‚¨èŠ‚çœå®è´µçš„æ—¶é—´ã€‚

# å‚è€ƒæ–‡çŒ®

1. https://developer.apple.com/documentation/swift_packages/building_swift_packages_or_apps_that_use_them_in_continuous_integration_workflows
2. https://blog.miniasp.com/post/2018/05/28/Git-Credential-Howto
3. https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%87%AD%E8%AF%81%E5%AD%98%E5%82%A8
4. https://uptech.team/blog/swift-package-manager
5. https://docs.github.com/cn/github/using-git/caching-your-github-credentials-in-git
